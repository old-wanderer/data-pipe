package datapipe.core.data.generator

import datapipe.core.data.model.metadata.*
import com.google.gson.annotations.SerializedName
import datapipe.core.data.model.metadata.parser.serialize
import org.apache.logging.log4j.LogManager
import org.objectweb.asm.ClassWriter
import org.objectweb.asm.Opcodes
import org.objectweb.asm.Type
import java.io.File
import java.io.FileOutputStream

/**
 * @author: andrei shlykov
 * @since: 21.01.2018
 */
object ClassGenerator {

    private val logger = LogManager.getLogger(ClassGenerator::class.java)

    private val GENERATED_CLASS_FULL_NAME = GeneratedClass::class.java.canonicalName.replace(".", "/")
    private val loader = AutoGeneratedClassLoader()

    private var autoNameCounter = 0

    fun generateClassAndSave(metadata: MetadataClass, file: String): Class<GeneratedClass> {
        val className = genClassName()
        val byteCode = generateByteCode(className, metadata)

        val fileWriter = FileOutputStream(File(file))
        fileWriter.write(byteCode)
        fileWriter.close()

        return loadClass(className, byteCode)
    }

    fun generateClass(metadata: MetadataClass): Class<GeneratedClass> {
        val className = "datapipe/core/data/generated/${genClassName()}"
        val byteCode = generateByteCode(className, metadata)
        return loadClass(className, byteCode)
    }

    fun generateByteCode(className: String, metadata: MetadataClass): ByteArray {
        logger.info("generate byte code for class {}", className)
        logger.debug("generate byte code by metadata {}", metadata)

        val classWriter = ClassWriter(ClassWriter.COMPUTE_FRAMES)

        classWriter.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC,
                className, null, GENERATED_CLASS_FULL_NAME, null)

        val defaultConstructor = classWriter.visitMethod(Opcodes.ACC_PUBLIC,
                "<init>", "()V", null, null)
        defaultConstructor.visitCode()
        defaultConstructor.visitVarInsn(Opcodes.ALOAD, 0)
        defaultConstructor.visitMethodInsn(Opcodes.INVOKESPECIAL,
                GENERATED_CLASS_FULL_NAME, "<init>", "()V", false)
        defaultConstructor.visitInsn(Opcodes.RETURN)
        defaultConstructor.visitMaxs(1, 1)
        defaultConstructor.visitEnd()

        genStaticMetadataClass(metadata, classWriter, className)

        for (property in metadata.properties) {
            genProperty(property, classWriter)
        }

        classWriter.visitEnd()
        return classWriter.toByteArray()
    }

    @Suppress("UNCHECKED_CAST")
    private fun loadClass(className: String, byteCode: ByteArray): Class<GeneratedClass> =
            loader.loadNewClass(className.replace("/", "."), byteCode) as Class<GeneratedClass>

    private fun genStaticMetadataClass(metadata: MetadataClass, classWriter: ClassWriter, className: String) {
        classWriter.visitField(
                Opcodes.ACC_PUBLIC + Opcodes.ACC_STATIC + Opcodes.ACC_FINAL,
                "_metadata",
                "Ldatapipe/core/data/model/metadata/Metadata;",
                null,
                null
        ).visitEnd()


        val staticConstructor = classWriter.visitMethod(Opcodes.ACC_STATIC, "<clinit>", "()V", null, null)
        staticConstructor.visitCode()
        staticConstructor.visitLdcInsn(serialize(metadata))
        staticConstructor.visitMethodInsn(
                Opcodes.INVOKESTATIC,
                "datapipe/core/data/model/metadata/parser/TokenizeKt",
                "tokenize",
                "(Ljava/lang/String;)Ljava/util/List;",
                false)
        staticConstructor.visitMethodInsn(
                Opcodes.INVOKESTATIC,
                "datapipe/core/data/model/metadata/parser/MetadataTokenKt",
                "buildMetadataAstTree",
                "(Ljava/lang/Iterable;)Ldatapipe/core/data/model/metadata/parser/MetadataAstNode;",
                false
        )
        staticConstructor.visitMethodInsn(
                Opcodes.INVOKESTATIC,
                "datapipe/core/data/model/metadata/parser/MetadataTokenKt",
                "buildMetadata",
                "(Ldatapipe/core/data/model/metadata/parser/MetadataAstNode;)Ldatapipe/core/data/model/metadata/Metadata;",
                false
        )
        staticConstructor.visitFieldInsn(
                Opcodes.PUTSTATIC,
                className,
                "_metadata",
                "Ldatapipe/core/data/model/metadata/Metadata;"
        )
        staticConstructor.visitInsn(Opcodes.RETURN)
        staticConstructor.visitMaxs(2, 2)
        staticConstructor.visitEnd()
    }

    private fun genProperty(metadataProperty: MetadataProperty, classWriter: ClassWriter) {
        logger.debug("generate property by metadata {}", metadataProperty)
        val field = when (metadataProperty.type) {
            is MetadataPrimitive -> {
                val defaultValue = (metadataProperty as? MetadataPropertyDefaultValue)?.defaultValue
                classWriter.visitField(Opcodes.ACC_PUBLIC,
                        metadataProperty.name, getRealType(metadataProperty.type, maybePrimitive = true), null, defaultValue)
            }
            is MetadataList -> classWriter.visitField(Opcodes.ACC_PUBLIC,
                    metadataProperty.name, Type.getDescriptor(List::class.java), getRealType(metadataProperty.type), null)
            is MetadataClass -> {
                val clazz = metadataProperty.type.generatedClass
                classWriter.visitField(Opcodes.ACC_PUBLIC, metadataProperty.name,
                        Type.getDescriptor(clazz), null, null)
            }
            else -> {
                println("WARNING: cant create property not primitive type: ${metadataProperty.type}")
                return
            }
        }
        // TODO тест на генерацию SerializedName
        if (metadataProperty.aliasNames.isNotEmpty()) {
            val annotation = field.visitAnnotation(Type.getDescriptor(SerializedName::class.java), true)
            annotation.visit("value", metadataProperty.aliasNames.first())
            if (metadataProperty.aliasNames.size > 1) {
                annotation.visit("alternate", metadataProperty.aliasNames.drop(1).toTypedArray())
            }
            annotation.visitEnd()
        }
        field.visitEnd()
    }

    private fun getRealType(metadata: Metadata, maybePrimitive: Boolean = false): String = when (metadata) {
        PrimitiveString  -> Type.getDescriptor(String::class.java)
        PrimitiveDouble  -> if (maybePrimitive) Type.DOUBLE_TYPE.descriptor  else "Ljava/lang/Double;"
        PrimitiveBoolean -> if (maybePrimitive) Type.BOOLEAN_TYPE.descriptor else "Ljava/lang/Boolean;"
        PrimitiveLong    -> if (maybePrimitive) Type.LONG_TYPE.descriptor    else "Ljava/lang/Long;"
        is MetadataClass -> Type.getDescriptor(metadata.generatedClass)
        is MetadataList  -> "Ljava/util/List<${getRealType(metadata.containsType)}>;"
        else -> throw RuntimeException("Don't know type: $metadata")
    }

    private fun genClassName() = "AutoGeneratedClass${autoNameCounter++}"

}